## Updates up to 6th March 2024 

Changes

- Lines 274-288: add checking .mat file associated with mp4 file created from TvD2all to get automatic adjustment of the resolution mmPerPix and time axis
- Lines 329-333: similar to before, just creating the Time array according to the timestamps generated by Tvd2all as it has unconstant frame rate. 
- Lines 2402: change parfor library for the waitbar. Fix it for mac too

| Process   | Time (s)   | Notes                                     |
| --------- | ---------- | ----------------------------------------- |
| Parfor    | 454.132734 | Using 4 workers                           |
| Batch (1) | >1800      | Using 4 workers, and a job for each frame |
| Batch(2)  | 1713       | "Simple use "                               |

- Fixed flip image
- Fixed Clear
- Tried with reduced point features to track nearby the fascicle. No changes in tracking because it is local (hopefully)
- Should we add a box for adjusting via GUI the blocksize of opticflow? It seems to be the most critical parameter


## Tim mail

Just made a big change to the code, which I think is a big improvement. I uncoupled the aponeurosis and fascicle state estimation through adding a 3rd gain, fixing the bug with discussed. The key was making fascicle length a state in the state estimation.

For the fascicle, the 4 four states are now:

1. Superficial aponeurosis horizontal intersection point (corrected with a constant)
2. Superficial aponeurosis vertical intersection point (corrected with Hough or object detection on superficial aponeurosis)
3. Fascicle angle with the horizontal (corrected with Hough on fascicles)
4. Fascicle length (corrected with Hough or object detection on deep aponeurosis)

The 3 gains are:

1. Aponeurosis gain: corrects the Region of Interest (perhaps should be called ROI gain) --> **Then re-run OPTICFLOW** --> It's part of the drift according to TIM but I need to check
2. Fascicle – position gain: corrects the fascicle length according to ROI (perhaps should be called length gain) --> It's the most important
3. Fascicle – angle gain: corrects the fascicle angle according to Hough (independent of ROI/aponeurosis)

In general, gains 1 and 2 should depend on the quality of the aponeurosis-parts of the image, while gain 3 should depend on the quality of the fascicle-part of the image. Furthermore, because of non-linear relation between angle and length (i.e., cosine/sine), gain 3 should perhaps depend on the (average / minimal) fascicle angle (i.e., low gain if this angle is close to 0).

## To do

- [ ] Auto cropping of US image/video
- [ ] Downsample image (by 2 maybe?) for Timtrack --> @Tim checks lines 2410 and 2467. I put a hint
- [x] Block size 81 81 
- [ ] Define a block size based on the muscle ROI created by "Define fascicle" ?
- [ ] Open parfor at the beginning and keep open till 
- [ ] TVD2All --> check cutting pixels
- [ ] Play around and find bugs :D
